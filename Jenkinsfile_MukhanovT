pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'todo-app-mukhanovt'
        // Убираем MAVEN_PATH — в Linux Maven доступен как 'mvn'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Starting DevOps2 Pipeline - MukhanovT'
                checkout scm
            }
        }
        
        stage('Verify Tools') {
            steps {
                sh 'echo "Verifying Maven..."'
                sh 'which mvn'
                sh 'mvn --version'
                sh 'java -version'
                sh 'docker --version'
            }
        }
        
        stage('Build') {
            steps {
                sh '''
                    echo "Building Spring Boot application..."
                    cd app
                    mvn clean compile -q
                '''
            }
        }
        
        
        stage('Package') {
            steps {
                sh '''
                    echo "Packaging application..."
                    cd app
                    mvn package -DskipTests
                    echo "Generated JAR:"
                    ls -l target/*.jar
                '''
            }
        }
        
        stage('Docker Build') {
            steps {
                sh '''
                    echo "Building Docker image..."
                    docker build -f docker/Dockerfile_MukhanovT -t ${DOCKER_IMAGE}:${BUILD_NUMBER} .
                    docker tag ${DOCKER_IMAGE}:${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                    echo "Docker images created:"
                    docker images | grep ${DOCKER_IMAGE}
                '''
            }
        }
        
        stage('Docker Test') {
            steps {
                sh '''
                    echo "Testing Docker container..."
                    docker run -d -p 8080:8090 --name test-${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                    sleep 10
                    curl -f http://localhost:8080/tasks || echo "Test endpoint failed"
                    docker stop test-${BUILD_NUMBER}
                    docker rm test-${BUILD_NUMBER}
                    echo "Docker test completed"
                '''
            }
        }
        
        stage('Complete') {
            steps {
                echo 'Pipeline completed successfully - MukhanovT'
            }
        }
    }
    
    post {
        always {
            sh 'echo "Cleaning up..."'
            sh 'docker system prune -f || true'
        }
        success {
            echo 'SUCCESS: DevOps2 Pipeline completed - MukhanovT'
        }
        failure {
            echo 'FAILURE: DevOps2 Pipeline failed - MukhanovT'
        }
    }
}